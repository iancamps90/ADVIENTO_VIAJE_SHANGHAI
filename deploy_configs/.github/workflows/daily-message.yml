name: Daily Shanghai Message

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 9:00 AM (hora de Madrid)
    - cron: '0 7 * * *'  # 7:00 UTC = 9:00 AM Madrid
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

jobs:
  send-daily-message:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if it's December 2025
        id: check-date
        run: |
          CURRENT_DATE=$(date +"%Y-%m")
          if [ "$CURRENT_DATE" = "2025-12" ]; then
            echo "is_december=true" >> $GITHUB_OUTPUT
            echo "âœ… Es diciembre 2025, enviando mensaje"
          else
            echo "is_december=false" >> $GITHUB_OUTPUT
            echo "âŒ No es diciembre 2025, saltando envÃ­o"
          fi
      
      - name: Send daily message
        if: steps.check-date.outputs.is_december == 'true'
        run: |
          echo "ğŸš€ Enviando mensaje diario del calendario de Shanghai..."
          
          # Hacer peticiÃ³n al endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "https://shanghai.iancamps.dev/api/daily-message")
          
          # Separar respuesta y cÃ³digo HTTP
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“Š CÃ³digo de respuesta: $HTTP_CODE"
          echo "ğŸ“ Respuesta: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Mensaje enviado correctamente"
          else
            echo "âŒ Error al enviar mensaje"
            exit 1
          fi
      
      - name: Send test message (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ§ª Enviando mensaje de prueba..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://shanghai.iancamps.dev/api/daily-message" \
            -H "Content-Type: application/json" \
            -d '{"day": 1}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“Š CÃ³digo de respuesta: $HTTP_CODE"
          echo "ğŸ“ Respuesta: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Mensaje de prueba enviado correctamente"
          else
            echo "âŒ Error al enviar mensaje de prueba"
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ El envÃ­o del mensaje diario fallÃ³"
          echo "ğŸ” Revisa los logs para mÃ¡s detalles"
